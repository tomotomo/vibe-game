# Duel Daifugo (デュエル大富豪) ゲーム仕様書

## 1. ゲーム概要
プレイヤーとCPUが対戦する、1対1の「大富豪」カードゲーム。
Unity WebGLビルドを想定し、スマートフォン（縦画面）でのプレイに最適化されたUIを持つ。

## 2. ルール仕様

### 基本ルール
- **人数**: 1対1 (Player vs CPU)
- **カード**: ジョーカーを除く52枚 (各スート A, 2..10, J, Q, K)
- **強さ**: 3 < 4 < ... < 13(K) < 1(A) < 2
- **革命時**: 2 < 1(A) < 13(K) < ... < 3
- **勝利条件**: 先に手札を全て出し切ったプレイヤーの勝利。

### 採用ローカルルール
1.  **8切り (8 Cut)**
    - 8を含むカードが出された場合、その場で場が流され（Field Clear）、出したプレイヤーの親ターンとなる。
2.  **5スキップ (5 Skip)**
    - 5を含むカードが出された場合、対戦相手のターンをスキップし、続けて自分のターンとなる。
    - 場は流れないため、プレイヤーは続けて自分の出した5よりも強いカードを出す必要がある。
3.  **Jバック (J Back)**
    - 11(J)が出されると、その場が流れるまで一時的に「革命」状態となり、カードの強さが反転する。
    - すでに革命状態の場合は、一時的に「通常」状態に戻る（カウンター革命）。
    - 場が流れる（パスで親が移る、または8切り）と、Jバックの効果は消失し、元の状態に戻る。
4.  **スート縛り (Suit Binding / Shibari)**
    - 台札（場に出ているカード）と同じスートのカードが出された場合、その場が流れるまで、そのスートしか出せなくなる。
    - 複数枚出しの場合は、全てのスートが一致した場合のみ発生。
5.  **革命 (Revolution)**
    - 同じ数字のカードを4枚以上出すと「革命」が発生し、カードの強さが反転する（2 < 1 < 13 ... < 3）。

## 3. ゲームフロー

### A. 開始フェーズ
1.  **タイトル画面**: "START GAME" ボタンで開始。
2.  **手札決定演出**:
    - プレイヤーとCPUそれぞれがサイコロを振るアニメーション。
    - サイコロ２つの合計値が、そのラウンドの初期手札枚数となる（例: 3+4=7枚ずつ配布）。
    - 残りのカードは山札となるが、ゲーム中には使用しない（1vs1の短縮ルール）。
3.  **手札配布**: ランダムにシャッフルして配布。手札は強さ順に自動ソートされる。
    - 先行・後攻はランダムに決定される。

### B. プレイフェーズ
- **親（Lead）**:
    - 好きなカード（単体、または同じランクの複数枚）を出せる。
- **子（Follow）**:
    - 場のカードと同じ枚数で、より強いカードを出せる。
    - 出せない、または出したくない場合は「PASS」を選択。
    - パスした場合は場が流れる。

### C. 終了フェーズ
- どちらかの手札が0枚になった時点で終了。
- 勝敗（YOU WIN / CPU WINS）を表示。
- 戦績（試合数、勝利数、勝率、連勝回数、最高連勝回数）を更新して表示。（データはブラウザを閉じても残るように永続化）
- "RETRY" ボタンで、同じ設定のまま即座に次のゲームを開始。
- "QUIT"ボタンで、タイトル画面に戻る

### 補足：CPUの思考ルーチンについて
1. **基本戦略**: 現在の革命状態（IsEffectiveRevolution）を考慮し、手札の中で最も弱いカード（または組み合わせ）から出すことを優先する。
2. **温存戦略**: A, 2, 5, 8 を含むカード（またはその組み合わせ）が手札に残る「最後のセット」となる場合を除き、それらを温存する。
    - ただし、それを出して上がれる（勝利確定）場合は温存せずに出す。
    - 温存対象のカードしか出せない場合は、あえて「PASS」を選択する戦略的パスを行う。

## 4. UI / UX 仕様
UIはすべて英語表記

### 画面レイアウト
- **解像度**: 縦長 (Mobile Portrait: 540x960 推奨)

#### タイトル画面
- **構成**:
    - **上部**: ゲームタイトル
    - **中央・下部**: 対戦、ルール説明の2つのボタンがありタップすることでそれぞれの画面に遷移する

#### ルール説明画面
- **構成**:
    - **上部**: ゲームルール（大富豪の基本ルールと特殊ルール）、スクリーンからはみ出る場合はスクロールして読めるようにする
    - **フッター**: ゲーム開始ボタン、タイトルに戻るボタンを左右に並べる

#### プレイ画面
- **構成**:
    - **上部**: CPUの手札（裏面表示）
    - **中央**: フィールド（場に出ているカード）
    - **下部**: プレイヤーの手札（手札が7枚以上のときは、UnityのGridLayoutGroup等の機能で2列にして表示）
    - **フッター**: 操作ボタン (PLAY, PASS, RETRY, EXIT)を必要なときだけ表示する

### サイコロアニメーション
- 数字テキスト（Textコンポーネント）を約1秒間（20フレーム）、ランダムな数値で更新し続けるループ処理で表現。
- 画面中央に、左右２個のサイコロを並べてアニメーションする
- 目が出たら合計値を計算して、手札の枚数を決める

### カード表示
- **リソースパス**:
    - `Assets/Resources/Cards/` 以下のスートごとの画像を使用（仕様変更：ルート直下ではない）。
- **デザイン**:
    - サイズはリアルなトランプの縦横比率。
    - 左上にスート画像＋ランク（数字）を小さく配置し、中央にスート画像を大きく配置。
    - **選択フィードバック**: 選択されたカードは、画像がハイライト（黄色）され、かつY座標が20ユニット上に移動する。
    - **配色**: ランクの文字色は、ハート・ダイヤは赤、スペード・クラブは黒で表示する。

### 操作系
- **タップ選択**: 手札をタップして選択/解除 -> "PLAY" ボタンで決定。
- **スマートプレイ**: 場にカードが出ている（Follow）状態で、手札をタップした際、そのカードを使って出せる組み合わせが一意に定まる場合は、自動的に選択・決定して即座に出す。
    - **スート縛り時の挙動**: 通常は選択肢が複数あっても、スート縛りによって「出せるカード」が一意に絞られる場合は、スマートプレイが発動する。
- **デバッグ**: "S" キーでスクリーンショット保存。

## 5. データ永続化 (PlayerPrefs)
ゲーム終了時に以下のキーで戦績データを保存する。
- `Stats_Games`: 総試合数
- `Stats_Wins`: 勝利数
- `Stats_Streak`: 現在の連勝数
- `Stats_MaxStreak`: 過去最高の連勝数
※勝率はこれらから動的に計算する。

## 6. 技術要件
- **エンジン**: Unity 2022.3.62f3
- **言語**: C#
- **アーキテクチャ**:
    - MonoBehaviourベースだが、ロジックとビューの分離を意識する。
- **ビルド**: WebGL (圧縮なし、RunInBackground有効)。サーバーを起動するバッチも作成

## 7. 実装詳細メモ（コード解析による補足）
- **Jバックの判定**: `IsRevolution ^ IsJBackActive` (XOR) で判定されるため、革命中にJバックが発生すると一時的に通常状態に戻る（カウンター革命）。
- **5スキップの挙動**: スキップ発生後、場はクリアされず、プレイヤーは自分が出した「5」よりも強いカードを出さなければならない（連続手番）。
- **スート縛り（複数枚）**: ペアなどで縛りが発生する場合、単にスートが含まれるだけでなく、スートの構成（例：ハートとダイヤのペア）が完全に一致している必要がある。
- **パス処理**: パスが行われると場がクリアされ、最後にカードを出したプレイヤーに親権が移る。

## 8. 実装するクラス

1. Suit (Enum)
2. Card (Class)
3. RuleManager (Class - ロジックの中核)

テストするクラス:
1. RuleManagerTests